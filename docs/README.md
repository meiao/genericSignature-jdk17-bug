# Investigation

It was first pointed out that a call to get a method generic return type was throwing an exception.

During the [investigation](https://github.com/newrelic/newrelic-java-agent/issues/526) it was found that the exception was thrown while gathering the method's data.

And the cause of the exception was that the signature returned by `Class#getGenericSignature0` was `java/util/concurrent/CompletableFuture` while the correct value is `<T:Ljava/lang/Object;>Ljava/lang/Object;Ljava/util/concurrent/Future<TT;>;`.

Given that `Class#getGenericSignature0` is a native method, the next step was to inspect the generated bytecode.

A simplified version of the instrumentation was created. This version did not change anything in the code, it only adds a couple of annotations to the class. Even then the problem persisted. And looking at the bytecode, both instrumented and original contain a line with the proper signature: 
`Signature: #xyz // <T:Ljava/lang/Object;>Ljava/lang/Object;Ljava/util/concurrent/Future<TT;>;Ljava/util/concurrent/CompletionStage<TT;>;`.

Bytecodes:
- [original CompletableFuture](CompletableFuture.bytecode.txt).
- [instrumented CompletableFuture](CompletableFuture-instrumented.bytecode.txt)

Further comparing the bytecodes, the only differences are the order of the items in the constant pool (which cause the references throught the class to change), the order of the methods and the order of the tables in each method (LineNumberTable, LocalVariableTable, LocalVariableTypeTable).

Since the bytecode did not provide any clue, the next step was to debug the JVM itself.

`ClassFileParser::apply_parsed_class_attributes` is called twice for `CompletableFuture`. Once before instrumentation and once after. And in both cases, the `_generic_signature_index` is correct.

Following the execution to `VM_RedefineClasses::merge_cp_and_rewrite`, in `VM_RedefineClasses::rewrite_cp_refs`, it rewrites the generic signature index. The `generic_signature_index` contains the correct index for the instrumented class. `new_generic_signature_index` then points to the generic signature index in the bytecode for the original `CompletableFuture`. And it sets the old index on the new class. It looks like at this point the Constant Pool in memory is no longer the same as the pool in the bytecode that is returned from instrumentation.
